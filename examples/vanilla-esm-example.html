<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vanilla JS + ESM TMDB Client (TV Shows)</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 0 15px;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      li:hover {
        background-color: #f0f0f0;
      }
      img {
        width: 40px;
        height: auto;
        vertical-align: middle;
        margin-right: 10px;
      }
      .status {
        margin-top: 20px;
        font-style: italic;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      .details {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        min-height: 50px;
        word-wrap: break-word;
      }
      .details pre {
        background-color: #eee;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
      }
      hr {
        margin: 30px 0;
      }
      /* Стили для двух колонок */
      .main-content {
        display: flex;
        gap: 20px; /* Пространство между колонками */
      }
      #details-container {
        flex: 1 1 40%; /* Детали занимают 40% ширины */
        order: 1; /* Детали слева */
        margin-top: 0; /* Убираем верхний отступ */
        align-self: flex-start; /* Выравниваем по верху */
      }
      #tv-list-container {
        /* Новый контейнер для списка */
        flex: 1 1 60%; /* Список занимает 60% */
        order: 2; /* Список справа */
      }
      #tv-list li {
        /* Стили для элемента списка, если нужно */
        word-wrap: break-word;
      }
      /* Стили для кнопки и скрытого блока */
      .raw-data-container {
        margin-top: 15px;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
      }
      .raw-data-content {
        display: none; /* Скрыто по умолчанию */
      }
      .raw-data-content.visible {
        display: block;
      }
      button.toggle-raw-data {
        margin-top: 10px;
        padding: 5px 10px;
        cursor: pointer;
      }
      .view-controls button {
        padding: 8px 15px;
        margin: 0 5px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 4px;
      }
      .view-controls button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1>Популярные Фильмы и Сериалы (Vanilla JS + ESM Пример)</h1>

    <div class="view-controls">
      <button id="show-popular-btn" class="active">Популярные</button>
      <button id="show-latest-btn">Последние добавленные</button>
    </div>

    <div class="main-content">
      <div id="details-container" class="details">
        <div
          id="details-status"
          style="font-style: italic; margin-bottom: 10px"
        >
          Кликните на фильм или сериал в списке, чтобы увидеть детали.
        </div>
        <div id="details-content"></div>
      </div>
      <div id="tv-list-container">
        <h2 id="list-title">Популярные фильмы и сериалы</h2>
        <ul id="media-list"></ul>
        <div
          id="error-message"
          style="color: red; margin-top: 10px; display: none"
        ></div>
        <button
          id="load-more-btn"
          style="
            display: none;
            margin-top: 15px;
            padding: 8px 15px;
            cursor: pointer;
          "
        >
          Загрузить еще...
        </button>
        <div id="status-messages" class="status"></div>
        <!-- Кнопка "Загрузить еще" здесь не реализована для простоты -->
      </div>
    </div>

    <hr />

    <!--
      Подключаем наш скрипт как МОДУЛЬ.
      Внутри него мы будем импортировать библиотеку из CDN (unpkg).
    -->
    <script type="module">
      import {
        createXhZlobaClient,
        ApiError,
        Movie,
        TVShow,
      } from "../dist/index.esm.js"; // Используем локальную сборку
      // import { createXhZlobaClient, ApiError, Movie, TVShow } from 'https://unpkg.com/tmdb-xhzloba@latest/dist/index.esm.js';

      const API_KEY = "4ef0d7355d9ffb5151e987764708ce96"; // ВАЖНО: Ключ вставлен!
      // Убираем проверку, так как ключ теперь есть
      // if (API_KEY === "ТУТ_ВАШ_КЛЮЧ_API") {
      //   alert(
      //     "Пожалуйста, замените 'ТУТ_ВАШ_КЛЮЧ_API' на ваш реальный API ключ TMDB в файле vanilla-esm-example.html"
      //   );
      // }
      // Передаем undefined первым аргументом для baseURL (чтобы взять дефолтный),
      // а API_KEY - вторым, как требует функция.
      const client = createXhZlobaClient(undefined, API_KEY);

      const mediaListElement = document.getElementById("media-list");
      const detailsContainerElement =
        document.getElementById("details-container");
      const detailsContentElement = document.getElementById("details-content");
      const detailsStatusElement = document.getElementById("details-status");
      const loadMoreBtn = document.getElementById("load-more-btn");
      const errorMessageElement = document.getElementById("error-message");
      const listTitleElement = document.getElementById("list-title");
      const showPopularBtn = document.getElementById("show-popular-btn");
      const showLatestBtn = document.getElementById("show-latest-btn");

      let currentPage = 1;
      let totalPages = 1;
      let isLoading = false;
      let isDetailsLoading = false;
      let mediaList = []; // Общий список для хранения загруженных Movie/TVShow объектов
      let currentView = "popular"; // 'popular' или 'latest'

      function showDetailsStatus(message, isError = false) {
        if (detailsStatusElement) {
          detailsStatusElement.textContent = message;
          detailsStatusElement.style.color = isError ? "red" : "black";
          detailsStatusElement.style.display = "block";
        }
        if (detailsContentElement) {
          detailsContentElement.style.display = "none"; // Скрываем основной контент при статусе
        }
      }

      async function displayMediaDetails(mediaItemData) {
        if (
          !detailsContainerElement ||
          !detailsContentElement ||
          isDetailsLoading
        )
          return;

        detailsContainerElement.style.display = "block";
        detailsContentElement.innerHTML = ""; // Очищаем старые детали
        showDetailsStatus("Загрузка деталей...");
        isDetailsLoading = true;

        try {
          let details;
          let fetchOptions = {
            language: "ru",
            appendToResponse: ["credits", "videos", "images", "external_ids"],
          };

          // Определяем, что запрашивать - фильм или сериал
          if (mediaItemData instanceof Movie) {
            details = await client.media.getMovieDetails(
              mediaItemData.id,
              fetchOptions
            );
          } else if (mediaItemData instanceof TVShow) {
            details = await client.media.getTVShowDetails(
              mediaItemData.id,
              fetchOptions
            );
          } else {
            throw new Error(
              "Неизвестный тип медиа элемента для загрузки деталей."
            );
          }

          // --- Человекочитаемая часть ---
          let detailsHtml = `<h2>${details.title || details.name}</h2>`;
          detailsHtml += `<img src="${details.getPosterUrl(
            "w342"
          )}" alt="Постер" style="max-width: 200px; float: left; margin-right: 15px;">`;
          detailsHtml += `<p><strong>Описание:</strong> ${
            details.overview || "Нет описания"
          }</p>`;
          detailsHtml += `<ul>`;
          detailsHtml += `<li><strong>ID:</strong> ${details.id}</li>`;
          detailsHtml += `<li><strong>Рейтинг TMDB:</strong> ${details.voteAverage.toFixed(
            1
          )} (${details.voteCount} голосов)</li>`;
          if (details instanceof Movie) {
            detailsHtml += `<li><strong>Дата выхода:</strong> ${
              details.getFormattedReleaseDate("ru-RU") || "N/A"
            }</li>`;
            detailsHtml += `<li><strong>Длительность:</strong> ${
              details.runtime ? details.runtime + " мин." : "N/A"
            }</li>`;
          } else if (details instanceof TVShow) {
            detailsHtml += `<li><strong>Дата первого показа:</strong> ${
              details.getFormattedFirstAirDate("ru-RU") || "N/A"
            }</li>`;
            detailsHtml += `<li><strong>Сезонов:</strong> ${
              details.numberOfSeasons || "N/A"
            }</li>`;
            detailsHtml += `<li><strong>Эпизодов:</strong> ${
              details.numberOfEpisodes || "N/A"
            }</li>`;
            detailsHtml += `<li><strong>Статус:</strong> ${
              details.inProduction ? "В производстве" : "Завершен"
            }</li>`;
          }
          // Доп. поля от прокси, если есть в детальном ответе
          detailsHtml += `<li><strong>ID Кинопоиска (детали):</strong> ${
            details.external_ids?.kinopoisk ||
            mediaItemData.kinopoiskId ||
            "N/A"
          }</li>`;
          detailsHtml += `<li><strong>ID IMDb (детали):</strong> ${
            details.external_ids?.imdb_id || mediaItemData.imdbId || "N/A"
          }</li>`;

          // Актеры и режиссеры (если есть credits)
          if (details.credits) {
            const directors = details.getDirectors();
            if (directors.length > 0) {
              detailsHtml += `<li><strong>Режиссеры:</strong> ${directors
                .map((d) => d.name)
                .join(", ")}</li>`;
            }
            const cast = details.getCast(10); // Первые 10 актеров
            if (cast.length > 0) {
              detailsHtml += `<li><strong>В ролях:</strong> ${cast
                .map((c) => c.name)
                .join(", ")}</li>`;
            }
          }
          detailsHtml += `</ul>`;

          detailsContentElement.innerHTML = detailsHtml;
          detailsStatusElement.style.display = "none"; // Скрываем статус
          detailsContentElement.style.display = "block"; // Показываем контент
        } catch (error) {
          console.error(`Ошибка загрузки деталей:`, error);
          let msg = "Неизвестная ошибка загрузки деталей";
          if (error instanceof ApiError) {
            msg = `API Ошибка деталей (${error.statusCode}): ${
              error.apiMessage || error.message
            }`;
          }
          showDetailsStatus(msg, true);
        } finally {
          isDetailsLoading = false;
        }
      }

      // --- Функция загрузки и отображения данных ---
      async function fetchAndDisplay(page = 1) {
        if (isLoading) return;
        isLoading = true;
        errorMessageElement.style.display = "none";
        if (page === 1) {
          mediaListElement.innerHTML = ""; // Очищаем список только для первой страницы
          mediaList = []; // Сбрасываем общий список
          currentPage = 1;
        }
        if (loadMoreBtn) loadMoreBtn.textContent = "Загрузка...";

        try {
          let result;
          // Выбираем, какой метод вызывать в зависимости от текущего вида
          if (currentView === "popular") {
            listTitleElement.textContent = "Популярные фильмы и сериалы";
            result = await client.media.getPopular(page);
          } else if (currentView === "latest") {
            listTitleElement.textContent =
              "Последние добавленные фильмы и сериалы";
            result = await client.media.getLatest(page);
          } else {
            throw new Error("Неизвестный тип отображения: " + currentView);
          }

          console.log(`Loaded ${currentView} page ${page}:`, result);
          totalPages = result.totalPages;
          currentPage = result.page;

          // Добавляем новые элементы в общий список и DOM
          result.items.forEach((item) => {
            console.log("Processing item:", item); // Оставляем лог для kinopoisk_id
            if (item instanceof Movie || item instanceof TVShow) {
              mediaList.push(item); // Добавляем в общий список
              const li = document.createElement("li");
              li.setAttribute("data-media-id", item.id.toString());
              li.innerHTML = `
                <img src="${item.getPosterUrl(
                  "w92"
                )}" alt="Постер" loading="lazy">
                <div>
                  <strong>${item.title || item.name}</strong> (${
                item instanceof Movie ? "Фильм" : "Сериал"
              }, ${
                item instanceof Movie
                  ? item.releaseDate?.substring(0, 4) || "N/A"
                  : item.firstAirDate?.substring(0, 4) || "N/A"
              })
                  <br>
                  <small>TMDB: ${item.voteAverage.toFixed(1)} | KP ID: ${
                item.kinopoiskId || "N/A"
              }</small>
                </div>
              `;
              mediaListElement.appendChild(li);
            } else {
              console.warn("Получен элемент неизвестного типа:", item);
            }
          });

          // Управляем кнопкой "Загрузить еще"
          if (loadMoreBtn) {
            loadMoreBtn.style.display =
              currentPage < totalPages ? "block" : "none";
            loadMoreBtn.textContent = "Загрузить еще...";
          }
        } catch (error) {
          console.error("Ошибка при загрузке данных:", error);
          let msg = "Неизвестная ошибка";
          if (error instanceof ApiError) {
            msg = `API Ошибка (${error.statusCode}): ${
              error.apiMessage || error.message
            }`;
          }
          errorMessageElement.textContent = `Не удалось загрузить данные. ${msg}`;
          errorMessageElement.style.display = "block";
          if (loadMoreBtn) loadMoreBtn.style.display = "none";
        } finally {
          isLoading = false;
          if (loadMoreBtn && !isLoading)
            loadMoreBtn.textContent = "Загрузить еще...";
        }
      }

      // --- Обработчик клика на список (для показа деталей) ---
      if (mediaListElement) {
        mediaListElement.addEventListener("click", (event) => {
          const clickedLi = event.target.closest("li[data-media-id]");
          if (clickedLi) {
            const mediaIdStr = clickedLi.getAttribute("data-media-id");
            if (mediaIdStr) {
              const mediaId = parseInt(mediaIdStr, 10);
              // Ищем объект в нашем общем массиве
              const mediaItemData = mediaList.find(
                (item) => item.id === mediaId
              );
              if (
                mediaItemData instanceof Movie ||
                mediaItemData instanceof TVShow
              ) {
                displayMediaDetails(mediaItemData);
              } else {
                console.warn(
                  "Clicked item not found or invalid type in mediaList"
                );
                showDetailsStatus(
                  "Не удалось найти данные для этого элемента.",
                  true
                );
              }
            }
          }
        });
      }

      // --- Обработчик для кнопки "Загрузить еще" ---
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", () => {
          // Загружаем следующую страницу для ТЕКУЩЕГО вида
          if (!isLoading && currentPage < totalPages) {
            fetchAndDisplay(currentPage + 1);
          }
        });
      }

      // --- Обработчики для кнопок переключения вида ---
      if (showPopularBtn) {
        showPopularBtn.addEventListener("click", () => {
          if (currentView !== "popular" && !isLoading) {
            currentView = "popular";
            showPopularBtn.classList.add("active");
            showLatestBtn.classList.remove("active");
            detailsContainerElement.style.display = "none"; // Скрываем детали при смене вида
            fetchAndDisplay(1); // Загружаем первую страницу нового вида
          }
        });
      }

      if (showLatestBtn) {
        showLatestBtn.addEventListener("click", () => {
          if (currentView !== "latest" && !isLoading) {
            currentView = "latest";
            showLatestBtn.classList.add("active");
            showPopularBtn.classList.remove("active");
            detailsContainerElement.style.display = "none"; // Скрываем детали при смене вида
            fetchAndDisplay(1); // Загружаем первую страницу нового вида
          }
        });
      }

      // --- Запуск ---
      fetchAndDisplay(1); // Загружаем первую страницу (по умолчанию 'popular') при старте
    </script>
  </body>
</html>
