<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vanilla JS + ESM TMDB Client (TV Shows)</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 0 15px;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      li:hover {
        background-color: #f0f0f0;
      }
      img {
        width: 40px;
        height: auto;
        vertical-align: middle;
        margin-right: 10px;
      }
      .status {
        margin-top: 20px;
        font-style: italic;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      .details {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        min-height: 50px;
        word-wrap: break-word;
      }
      .details pre {
        background-color: #eee;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
      }
      hr {
        margin: 30px 0;
      }
      /* Стили для двух колонок */
      .main-content {
        display: flex;
        gap: 20px; /* Пространство между колонками */
      }
      #details-container {
        flex: 1 1 40%; /* Детали занимают 40% ширины */
        order: 1; /* Детали слева */
        margin-top: 0; /* Убираем верхний отступ */
        align-self: flex-start; /* Выравниваем по верху */
      }
      #tv-list-container {
        /* Новый контейнер для списка */
        flex: 1 1 60%; /* Список занимает 60% */
        order: 2; /* Список справа */
      }
      #tv-list li {
        /* Стили для элемента списка, если нужно */
        word-wrap: break-word;
      }
      /* Стили для кнопки и скрытого блока */
      .raw-data-container {
        margin-top: 15px;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
      }
      .raw-data-content {
        display: none; /* Скрыто по умолчанию */
      }
      .raw-data-content.visible {
        display: block;
      }
      button.toggle-raw-data {
        margin-top: 10px;
        padding: 5px 10px;
        cursor: pointer;
      }
      .view-controls button {
        padding: 8px 15px;
        margin: 0 5px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 4px;
      }
      .view-controls button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }
      .view-controls select {
        padding: 8px 10px;
        margin-right: 10px;
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <h1>Популярные Фильмы и Сериалы (Vanilla JS + ESM Пример)</h1>

    <div class="view-controls">
      <label for="view-selector">Выберите список:</label>
      <select id="view-selector">
        <option value="getPopular" selected>Популярные (все)</option>
        <option value="getLatest">Последние добавленные (все)</option>
        <option value="getNowPlaying">Сейчас смотрят (все)</option>
        <option value="getPopularMovies">Популярные (фильмы)</option>
        <option value="getPopularTVShows">Популярные (сериалы)</option>
        <option value="getLatestMovies">Последние добавленные (фильмы)</option>
        <option value="getLatestTvShows">
          Последние добавленные (сериалы)
        </option>
        <option value="getNowPlayingMovies">Сейчас смотрят (фильмы)</option>
        <option value="getNowPlayingTvShows">Сейчас смотрят (сериалы)</option>
      </select>
    </div>

    <div class="main-content">
      <div id="details-container" class="details">
        <div
          id="details-status"
          style="font-style: italic; margin-bottom: 10px"
        >
          Кликните на фильм или сериал в списке, чтобы увидеть детали.
        </div>
        <div id="details-content"></div>
      </div>
      <div id="tv-list-container">
        <h2 id="list-title">Популярные фильмы и сериалы</h2>
        <ul id="media-list"></ul>
        <div
          id="error-message"
          style="color: red; margin-top: 10px; display: none"
        ></div>
        <button
          id="load-more-btn"
          style="
            display: none;
            margin-top: 15px;
            padding: 8px 15px;
            cursor: pointer;
          "
        >
          Загрузить еще...
        </button>
        <div id="status-messages" class="status"></div>
        <!-- Кнопка "Загрузить еще" здесь не реализована для простоты -->
      </div>
    </div>

    <hr />

    <!--
      Подключаем наш скрипт как МОДУЛЬ.
      Внутри него мы будем импортировать библиотеку из CDN (unpkg).
    -->
    <script type="module">
      import {
        createXhZlobaClient,
        ApiError,
        Movie,
        TVShow,
      } from "../dist/index.esm.js"; // Используем локальную сборку
      // import { createXhZlobaClient, ApiError, Movie, TVShow } from 'https://unpkg.com/tmdb-xhzloba@latest/dist/index.esm.js';

      const API_KEY = "4ef0d7355d9ffb5151e987764708ce96"; // ВАЖНО: Ключ вставлен!
      // Убираем проверку, так как ключ теперь есть
      // if (API_KEY === "ТУТ_ВАШ_КЛЮЧ_API") {
      //   alert(
      //     "Пожалуйста, замените 'ТУТ_ВАШ_КЛЮЧ_API' на ваш реальный API ключ TMDB в файле vanilla-esm-example.html"
      //   );
      // }
      // Передаем undefined первым аргументом для baseURL (чтобы взять дефолтный),
      // а API_KEY - вторым, как требует функция.
      const client = createXhZlobaClient(undefined, API_KEY);

      // --- Получение элементов DOM ---
      const mediaListElement = document.getElementById("media-list");
      const detailsContainerElement =
        document.getElementById("details-container");
      const detailsContentElement = document.getElementById("details-content");
      const detailsStatusElement = document.getElementById("details-status");
      const loadMoreBtn = document.getElementById("load-more-btn");
      const errorMessageElement = document.getElementById("error-message");
      const listTitleElement = document.getElementById("list-title");
      const viewSelector = document.getElementById("view-selector");

      // --- Состояние приложения ---
      let currentPage = 1;
      let totalPages = 1;
      let isLoading = false;
      let isDetailsLoading = false;
      let mediaList = []; // Общий список для хранения загруженных Movie/TVShow объектов
      let currentMethodName = viewSelector ? viewSelector.value : "getPopular"; // Текущий выбранный метод

      // --- Хелперы ---
      function showDetailsStatus(message, isError = false) {
        if (detailsStatusElement) {
          detailsStatusElement.textContent = message;
          detailsStatusElement.style.color = isError ? "red" : "black";
          detailsStatusElement.style.display = "block";
        }
        if (detailsContentElement) {
          detailsContentElement.style.display = "none";
          detailsContentElement.innerHTML = ""; // Очищаем контент при показе статуса
        }
      }

      // --- Загрузка и отображение ДЕТАЛЕЙ МЕДИА (с выводом всех полей) ---
      async function displayMediaDetails(mediaItemData) {
        if (
          !detailsContainerElement ||
          !detailsContentElement ||
          isDetailsLoading
        )
          return;

        detailsContainerElement.style.display = "block";
        showDetailsStatus("Загрузка деталей...");
        isDetailsLoading = true;

        try {
          let details;
          // Запрашиваем больше данных через appendToResponse
          let fetchOptions = {
            language: "ru",
            appendToResponse: [
              "credits",
              "videos",
              "images",
              "external_ids",
              "keywords",
              // 'recommendations', // Пока уберем, чтобы не перегружать
              // 'similar',
              // 'reviews',
              // 'watch/providers',
            ],
          };
          // Добавляем специфичные для типа поля
          if (mediaItemData instanceof Movie) {
            fetchOptions.appendToResponse.push("release_dates");
            details = await client.media.getMovieDetails(
              mediaItemData.id,
              fetchOptions
            );
          } else if (mediaItemData instanceof TVShow) {
            // Для TV пока нет уникальных appendToResponse, которые мы бы добавили
            details = await client.media.getTVShowDetails(
              mediaItemData.id,
              fetchOptions
            );
          } else {
            throw new Error(
              "Неизвестный тип медиа элемента для загрузки деталей."
            );
          }

          console.log("Получены детали:", details);

          // --- Просто выводим весь объект details как JSON ---
          let detailsHtml = `<h2>Детали объекта для ID: ${details.id}</h2>`;
          detailsHtml += `<pre style="white-space: pre-wrap; word-wrap: break-word; background: #fff; border: 1px solid #ccc; padding: 10px; max-height: 600px; overflow-y: auto;">
${JSON.stringify(details, null, 2)}
</pre>`;

          detailsContentElement.innerHTML = detailsHtml;
          detailsStatusElement.style.display = "none";
          detailsContentElement.style.display = "block";
        } catch (error) {
          console.error(`Ошибка загрузки деталей:`, error);
          let msg = "Неизвестная ошибка загрузки деталей";
          if (error instanceof ApiError) {
            msg = `API Ошибка деталей (${error.statusCode}): ${
              error.apiMessage || error.message
            }`;
          }
          showDetailsStatus(msg, true);
        } finally {
          isDetailsLoading = false;
        }
      }

      // --- Функция загрузки и отображения СПИСКА МЕДИА ---
      async function fetchAndDisplay(methodName, page = 1) {
        if (isLoading) return;
        isLoading = true;
        errorMessageElement.style.display = "none";
        if (page === 1) {
          mediaListElement.innerHTML = "";
          mediaList = [];
          currentPage = 1; // Сброс страницы при смене метода
        }
        if (loadMoreBtn) loadMoreBtn.textContent = "Загрузка...";

        // Обновляем заголовок в соответствии с выбранным методом
        const selectedOption = viewSelector.options[viewSelector.selectedIndex];
        listTitleElement.textContent = selectedOption.text;

        try {
          let result;
          // Динамически вызываем нужный метод клиента
          if (typeof client.media[methodName] === "function") {
            console.log(`Вызов client.media.${methodName}(${page})`);
            result = await client.media[methodName](page);
          } else {
            throw new Error(`Метод client.media.${methodName} не найден!`);
          }

          console.log(`Loaded ${methodName} page ${page}:`, result);
          totalPages = result.totalPages;
          currentPage = result.page;

          // Добавляем элементы в DOM и в массив
          if (result && result.items) {
            result.items.forEach((item) => {
              if (item instanceof Movie || item instanceof TVShow) {
                mediaList.push(item);
                const li = document.createElement("li");
                li.setAttribute("data-media-id", item.id.toString());
                const year =
                  item instanceof Movie
                    ? item.releaseDate?.substring(0, 4) || "N/A"
                    : item.firstAirDate?.substring(0, 4) || "N/A";
                li.innerHTML = `
                          <img src="${item.getPosterUrl(
                            "w92"
                          )}" alt="" loading="lazy" style="width:40px; height:60px; object-fit:cover;">
                          <div style="display: inline-block; vertical-align: top; margin-left: 5px;">
                          <strong>${item.title || item.name}</strong> (${
                  item instanceof Movie ? "Фильм" : "Сериал"
                }, ${year})
                          <br>
                          <small>TMDB: ${
                            item.voteAverage?.toFixed(1) ?? "N/A"
                          } | KP ID: ${item.kinopoiskId || "N/A"}</small>
                          </div>
                      `;
                mediaListElement.appendChild(li);
              } else {
                console.warn("Получен элемент не Movie/TVShow:", item);
              }
            });
          } else {
            console.warn("Результат API не содержит поля items:", result);
          }

          // Кнопка "Загрузить еще"
          if (loadMoreBtn) {
            loadMoreBtn.style.display =
              currentPage < totalPages ? "block" : "none";
            loadMoreBtn.textContent = "Загрузить еще...";
          }
        } catch (error) {
          console.error(`Ошибка при загрузке ${methodName}:`, error);
          let msg = "Неизвестная ошибка";
          if (error instanceof ApiError) {
            msg = `API Ошибка (${error.statusCode}): ${
              error.apiMessage || error.message
            }`;
          }
          errorMessageElement.textContent = `Не удалось загрузить данные (${methodName}). ${msg}`;
          errorMessageElement.style.display = "block";
          if (loadMoreBtn) loadMoreBtn.style.display = "none";
        } finally {
          isLoading = false;
          if (loadMoreBtn && !isLoading)
            loadMoreBtn.textContent = "Загрузить еще...";
        }
      }

      // --- Обработчик клика на список (для показа деталей) ---
      if (mediaListElement) {
        mediaListElement.addEventListener("click", (event) => {
          const clickedLi = event.target.closest("li[data-media-id]");
          if (clickedLi) {
            const mediaIdStr = clickedLi.getAttribute("data-media-id");
            if (mediaIdStr) {
              const mediaId = parseInt(mediaIdStr, 10);
              const mediaItemData = mediaList.find(
                (item) => item.id === mediaId
              );
              if (
                mediaItemData instanceof Movie ||
                mediaItemData instanceof TVShow
              ) {
                displayMediaDetails(mediaItemData);
              } else {
                console.warn("Clicked item not found or invalid type");
                showDetailsStatus(
                  "Не удалось найти данные для этого элемента.",
                  true
                );
              }
            }
          }
        });
      }

      // --- Обработчик для кнопки "Загрузить еще" ---
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", () => {
          if (!isLoading && currentPage < totalPages) {
            // Загружаем следующую страницу для ТЕКУЩЕГО метода
            fetchAndDisplay(currentMethodName, currentPage + 1);
          }
        });
      }

      // --- Обработчик для выбора метода ---
      if (viewSelector) {
        viewSelector.addEventListener("change", (event) => {
          const newMethodName = event.target.value;
          if (newMethodName !== currentMethodName && !isLoading) {
            console.log(`Смена вида на: ${newMethodName}`);
            currentMethodName = newMethodName;
            detailsContainerElement.style.display = "none"; // Скрываем детали
            fetchAndDisplay(currentMethodName, 1); // Загружаем первую страницу нового вида
          }
        });
      }

      // --- Запуск ---
      if (viewSelector) {
        // Устанавливаем начальное состояние из селектора
        currentMethodName = viewSelector.value;
        fetchAndDisplay(currentMethodName, 1); // Загружаем первую страницу выбранного вида
      } else {
        console.error("Не найден элемент #view-selector");
        // Можно загрузить что-то по умолчанию, если селектор не найден
        // fetchAndDisplay('getPopular', 1);
      }
    </script>
  </body>
</html>
